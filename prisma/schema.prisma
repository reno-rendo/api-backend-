// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USER & AUTHENTICATION
// ============================================================================

model User {
  id                  Int       @id @default(autoincrement())
  username            String?   @unique @db.VarChar(55)
  email               String    @unique @db.VarChar(200)
  phone               String?   @db.VarChar(14)
  password            String    @db.Text
  fullName            String    @db.VarChar(100)
  avatar              String?   @db.Text
  isVerified          Boolean   @default(false)
  
  // Location
  province            String?   @db.VarChar(255)
  city                String?   @db.VarChar(255)
  district            String?   @db.VarChar(255)
  provinceId          String?   @db.VarChar(255)
  cityId              String?   @db.VarChar(255)
  districtId          String?   @db.VarChar(255)
  
  // Account type
  role                UserRole  @default(USER)
  registerType        String?   @db.VarChar(50) // 'google', 'facebook', 'email'
  
  // Status
  status              UserStatus @default(OFFLINE)
  lastActiveAt        DateTime   @default(now()) @updatedAt
  token               String?    @db.VarChar(64)
  
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt
  
  // Relations
  store               Store?
  addresses           UserAddress[]
  orders              Order[]
  reviews             Review[]
  wishlist            Wishlist[]
  chatsSent           ChatMessage[] @relation("SentMessages")
  chatsReceived       ChatMessage[] @relation("ReceivedMessages")
  notifications       Notification[]
  cartItems           CartItem[]
  
  @@map("users")
}

model UserAddress {
  id              Int       @id @default(autoincrement())
  userId          Int
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  label           String    @db.VarChar(50) // 'Rumah', 'Kantor', etc.
  recipientName   String    @db.VarChar(100)
  phone           String    @db.VarChar(20)
  
  province        String    @db.VarChar(255)
  city            String    @db.VarChar(255)
  district        String    @db.VarChar(255)
  postalCode      String?   @db.VarChar(10)
  fullAddress     String    @db.Text
  
  provinceId      String    @db.VarChar(255)
  cityId          String    @db.VarChar(255)
  districtId      String    @db.VarChar(255)
  
  isDefault       Boolean   @default(false)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  orders          Order[]
  
  @@map("user_addresses")
}

enum UserRole {
  USER
  SELLER
  ADMIN
}

enum UserStatus {
  ONLINE
  OFFLINE
}

// ============================================================================
// STORE
// ============================================================================

model Store {
  id              Int       @id @default(autoincrement())
  userId          Int       @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name            String    @db.VarChar(200)
  slug            String    @unique @db.VarChar(255)
  description     String?   @db.Text
  logo            String?   @db.Text
  banner          String?   @db.Text
  
  isVerified      Boolean   @default(false)
  status          StoreStatus @default(ACTIVE)
  level           StoreLevel  @default(BRONZE)
  
  // Location
  province        String?   @db.VarChar(255)
  city            String?   @db.VarChar(255)
  district        String?   @db.VarChar(255)
  provinceId      String?   @db.VarChar(255)
  cityId          String?   @db.VarChar(255)
  districtId      String?   @db.VarChar(255)
  
  // Settings
  isOnHoliday     Boolean   @default(false)
  holidayNote     String?   @db.Text
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  products        Product[]
  vouchers        StoreVoucher[]
  orders          Order[]
  balance         StoreBalance?
  
  @@map("stores")
}

model StoreBalance {
  id              Int       @id @default(autoincrement())
  storeId         Int       @unique
  store           Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  balance         Decimal   @default(0) @db.Decimal(15, 2)
  pendingBalance  Decimal   @default(0) @db.Decimal(15, 2)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  withdrawals     StoreWithdrawal[]
  
  @@map("store_balances")
}

model StoreWithdrawal {
  id              Int       @id @default(autoincrement())
  balanceId       Int
  balance         StoreBalance @relation(fields: [balanceId], references: [id])
  
  amount          Decimal   @db.Decimal(15, 2)
  bankName        String    @db.VarChar(100)
  accountNumber   String    @db.VarChar(50)
  accountHolder   String    @db.VarChar(100)
  
  status          WithdrawalStatus @default(PENDING)
  processedAt     DateTime?
  notes           String?   @db.Text
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@map("store_withdrawals")
}

model StoreVoucher {
  id              Int       @id @default(autoincrement())
  storeId         Int
  store           Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  code            String    @db.VarChar(50)
  name            String    @db.VarChar(100)
  description     String?   @db.Text
  
  type            VoucherType @default(PERCENTAGE)
  discountValue   Int       // percentage or fixed amount
  minPurchase     Int       @default(0)
  maxDiscount     Int?      // for percentage type
  
  quota           Int       @default(0)
  usedCount       Int       @default(0)
  
  startDate       DateTime
  endDate         DateTime
  isActive        Boolean   @default(true)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  orders          Order[]
  
  @@unique([storeId, code])
  @@map("store_vouchers")
}

enum StoreStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum StoreLevel {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum VoucherType {
  PERCENTAGE
  FIXED
}

enum WithdrawalStatus {
  PENDING
  PROCESSING
  COMPLETED
  REJECTED
}

// ============================================================================
// PRODUCT CATALOG
// ============================================================================

model Category {
  id          Int       @id @default(autoincrement())
  name        String    @db.VarChar(200)
  slug        String    @unique @db.VarChar(200)
  icon        String?   @db.VarChar(255)
  parentId    Int?
  parent      Category? @relation("CategoryChildren", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryChildren")
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  products    Product[]
  
  @@map("categories")
}

model Brand {
  id          Int       @id @default(autoincrement())
  name        String    @db.VarChar(200)
  slug        String    @unique @db.VarChar(200)
  icon        String?   @db.VarChar(255)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  products    Product[]
  
  @@map("brands")
}

model Product {
  id              Int       @id @default(autoincrement())
  storeId         Int
  store           Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  categoryId      Int
  category        Category  @relation(fields: [categoryId], references: [id])
  brandId         Int?
  brand           Brand?    @relation(fields: [brandId], references: [id])
  
  title           String    @db.VarChar(200)
  slug            String    @unique @db.VarChar(255)
  description     String    @db.LongText
  
  price           Int       // Base price in IDR
  discount        Int       @default(0) // Percentage
  weight          Int       @default(0) // in grams
  stock           Int       @default(0)
  soldCount       Int       @default(0)
  
  condition       ProductCondition @default(NEW)
  hasWarranty     Boolean   @default(false)
  warrantyDesc    String?   @db.Text
  
  // Product type
  type            ProductType @default(PHYSICAL)
  downloadUrl     String?   @db.Text // For digital products
  demoUrl         String?   @db.Text
  
  // Shipping
  isFreeShipping  Boolean   @default(false)
  isFlashSale     Boolean   @default(false)
  
  // Status
  status          ProductStatus @default(ACTIVE)
  moderationStatus ModerationStatus @default(PENDING)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  images          ProductImage[]
  variants        ProductVariant[]
  reviews         Review[]
  wishlist        Wishlist[]
  cartItems       CartItem[]
  orderItems      OrderItem[]
  
  @@index([storeId])
  @@index([categoryId])
  @@index([brandId])
  @@map("products")
}

model ProductImage {
  id          Int       @id @default(autoincrement())
  productId   Int
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  url         String    @db.Text
  order       Int       @default(0)
  
  createdAt   DateTime  @default(now())
  
  @@map("product_images")
}

model ProductVariant {
  id          Int       @id @default(autoincrement())
  productId   Int
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  name        String    @db.VarChar(100) // e.g., "Size", "Color"
  value       String    @db.VarChar(100) // e.g., "XL", "Red"
  price       Int       // Price for this variant
  stock       Int       @default(0)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  cartItems   CartItem[]
  orderItems  OrderItem[]
  
  @@map("product_variants")
}

enum ProductCondition {
  NEW
  USED
  REFURBISHED
}

enum ProductType {
  PHYSICAL
  DIGITAL
}

enum ProductStatus {
  ACTIVE
  INACTIVE
  DELETED
}

enum ModerationStatus {
  PENDING
  APPROVED
  REJECTED
}

// ============================================================================
// SHOPPING & ORDERS
// ============================================================================

model CartItem {
  id          Int       @id @default(autoincrement())
  userId      Int
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId   Int
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId   Int?
  variant     ProductVariant? @relation(fields: [variantId], references: [id])
  
  quantity    Int       @default(1)
  notes       String?   @db.Text
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@unique([userId, productId, variantId])
  @@map("cart_items")
}

model Order {
  id              Int       @id @default(autoincrement())
  orderNumber     String    @unique @db.VarChar(50)
  
  userId          Int
  user            User      @relation(fields: [userId], references: [id])
  storeId         Int
  store           Store     @relation(fields: [storeId], references: [id])
  addressId       Int
  address         UserAddress @relation(fields: [addressId], references: [id])
  voucherId       Int?
  voucher         StoreVoucher? @relation(fields: [voucherId], references: [id])
  
  // Amounts
  subtotal        Int       // Product total
  shippingCost    Int       @default(0)
  discountAmount  Int       @default(0)
  totalAmount     Int       // Final amount
  
  // Shipping
  courier         String?   @db.VarChar(50)
  courierService  String?   @db.VarChar(100)
  estimatedDays   String?   @db.VarChar(20)
  trackingNumber  String?   @db.VarChar(100)
  
  // Payment
  paymentMethod   PaymentMethod @default(COD)
  paymentStatus   PaymentStatus @default(UNPAID)
  paidAt          DateTime?
  
  // Status
  status          OrderStatus @default(PENDING)
  notes           String?   @db.Text
  
  // Timestamps
  shippedAt       DateTime?
  deliveredAt     DateTime?
  completedAt     DateTime?
  cancelledAt     DateTime?
  cancelReason    String?   @db.Text
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  items           OrderItem[]
  
  @@index([userId])
  @@index([storeId])
  @@map("orders")
}

model OrderItem {
  id          Int       @id @default(autoincrement())
  orderId     Int
  order       Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   Int
  product     Product   @relation(fields: [productId], references: [id])
  variantId   Int?
  variant     ProductVariant? @relation(fields: [variantId], references: [id])
  
  // Snapshot at order time
  productName String    @db.VarChar(200)
  variantName String?   @db.VarChar(100)
  price       Int
  quantity    Int
  weight      Int
  
  createdAt   DateTime  @default(now())
  
  @@map("order_items")
}

enum PaymentMethod {
  COD
  BANK_TRANSFER
  VIRTUAL_ACCOUNT
  EWALLET
  QRIS
}

enum PaymentStatus {
  UNPAID
  PENDING
  PAID
  EXPIRED
  FAILED
  REFUNDED
}

enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  COMPLETED
  CANCELLED
  REFUND_REQUESTED
  REFUNDED
}

// ============================================================================
// REVIEWS & RATINGS
// ============================================================================

model Review {
  id          Int       @id @default(autoincrement())
  userId      Int
  user        User      @relation(fields: [userId], references: [id])
  productId   Int
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  rating      Int       // 1-5
  comment     String?   @db.Text
  images      Json?     // Array of image URLs
  
  isVerified  Boolean   @default(false) // Verified purchase
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@unique([userId, productId])
  @@map("reviews")
}

// ============================================================================
// WISHLIST
// ============================================================================

model Wishlist {
  id          Int       @id @default(autoincrement())
  userId      Int
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId   Int
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime  @default(now())
  
  @@unique([userId, productId])
  @@map("wishlists")
}

// ============================================================================
// CHAT & MESSAGING
// ============================================================================

model ChatMessage {
  id              Int       @id @default(autoincrement())
  senderId        Int
  sender          User      @relation("SentMessages", fields: [senderId], references: [id])
  receiverId      Int
  receiver        User      @relation("ReceivedMessages", fields: [receiverId], references: [id])
  
  message         String    @db.Text
  isRead          Boolean   @default(false)
  
  createdAt       DateTime  @default(now())
  
  @@index([senderId, receiverId])
  @@map("chat_messages")
}

// ============================================================================
// NOTIFICATIONS
// ============================================================================

model Notification {
  id          Int       @id @default(autoincrement())
  userId      Int
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        NotificationType
  title       String    @db.VarChar(200)
  message     String    @db.Text
  data        Json?     // Additional metadata
  
  isRead      Boolean   @default(false)
  readAt      DateTime?
  
  createdAt   DateTime  @default(now())
  
  @@index([userId])
  @@map("notifications")
}

enum NotificationType {
  ORDER
  PAYMENT
  SHIPPING
  PROMO
  CHAT
  REVIEW
  SYSTEM
}

// ============================================================================
// PROMOTIONS & BANNERS
// ============================================================================

model Banner {
  id          Int       @id @default(autoincrement())
  image       String    @db.Text
  title       String?   @db.VarChar(200)
  link        String?   @db.Text
  order       Int       @default(0)
  isActive    Boolean   @default(true)
  
  startDate   DateTime?
  endDate     DateTime?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@map("banners")
}

model FlashSale {
  id          Int       @id @default(autoincrement())
  name        String    @db.VarChar(200)
  startTime   DateTime
  endTime     DateTime
  isActive    Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@map("flash_sales")
}

// ============================================================================
// SEARCH & ANALYTICS
// ============================================================================

model SearchKeyword {
  id          Int       @id @default(autoincrement())
  keyword     String    @db.VarChar(255)
  count       Int       @default(1)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@unique([keyword])
  @@map("search_keywords")
}

// ============================================================================
// LOCATION DATA
// ============================================================================

model Province {
  id          Int       @id @default(autoincrement())
  name        String    @db.VarChar(255)
  
  cities      City[]
  
  @@map("provinces")
}

model City {
  id          Int       @id @default(autoincrement())
  provinceId  Int
  province    Province  @relation(fields: [provinceId], references: [id])
  name        String    @db.VarChar(255)
  type        String    @db.VarChar(50) // Kabupaten/Kota
  postalCode  String?   @db.VarChar(10)
  
  districts   District[]
  
  @@map("cities")
}

model District {
  id          Int       @id @default(autoincrement())
  cityId      Int
  city        City      @relation(fields: [cityId], references: [id])
  name        String    @db.VarChar(255)
  
  @@map("districts")
}

// ============================================================================
// BANK & PAYMENT SETTINGS
// ============================================================================

model Bank {
  id          Int       @id @default(autoincrement())
  name        String    @db.VarChar(255)
  code        String?   @db.VarChar(20)
  logo        String?   @db.VarChar(255)
  isActive    Boolean   @default(true)
  
  @@map("banks")
}
